---
- name: Check role variables
  ansible.builtin.include_tasks: check_vars.yml

- name: Install dependencies
  ansible.builtin.include_tasks: prepare_deps.yml
- name: Determine latest compatible version
  ansible.builtin.include_tasks: prepare_latest_compat_release.yml
  when: step_ca_version == "latest-compatible"
- name: Determine latest version
  ansible.builtin.include_tasks: prepare_latest_release.yml
  when: step_ca_version == "latest"

- name: Install step-cli # ensures that our cli version is also up-to-date
  include_role:
    name: maxhoesel.smallstep.step_cli

- name: Install step-ca
  ansible.builtin.include_tasks: install_ca.yml

- name: Configure CA
  block:
  - name: Configure CA user
    ansible.builtin.include_tasks: configure_ca_user.yml

  - name: Look for existing install
    stat:
      path: "{{ step_ca_path }}/config/ca.json"
    register: step_ca_config
  - name: Initialize CA
    ansible.builtin.include_tasks: configure_ca_init.yml
    when: not step_ca_config.stat.exists

  - name: Configure CA service
    ansible.builtin.include_tasks: configure_ca_service.yml
  when: step_ca_configure
